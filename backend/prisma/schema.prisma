generator client {
  provider     = "prisma-client"
  output       = "./generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "mysql"
}

//////////////////////
// USER (ADMIN)
//////////////////////
model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  fullName String  @map("full_name")
  phone    String?

  createdAt DateTime @default(now())
}

//////////////////////
// CUSTOMER
//////////////////////
model Customer {
  id       String  @id @default(uuid())
  email    String  @unique
  password String  @map("password")
  fullName String  @map("full_name")
  phone    String?

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("customer")
}

//////////////////////
// PRODUCT
//////////////////////
model Product {
  id          String        @id @default(uuid())
  title       String
  handle      String        @unique
  description String?
  status      ProductStatus @default(DRAFT)

  images     ProductImage[]
  variants   ProductVariant[]
  categories ProductCategory[]
  tags       ProductTag[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("product")
}

enum ProductStatus {
  DRAFT
  PUBLISHED
}

//////////////////////
// PRODUCT VARIANT
// (SKU cụ thể + tồn kho + option dạng JSON)
//////////////////////
model ProductVariant {
  id        String @id @default(uuid())
  productId String @map("product_id")

  sku        String  @unique
  price      Decimal @db.Decimal(12, 2)
  stock      Int
  attributes Json // { "color": "Black", "size": "L" }

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("product_variant")
}

//////////////////////
// PRODUCT IMAGE
//////////////////////
model ProductImage {
  id        String @id @default(uuid())
  productId String @map("product_id")
  url       String
  position  Int

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_image")
}

//////////////////////
// TAG
//////////////////////
model Tag {
  id   String @id @default(uuid())
  name String @unique

  products ProductTag[]
}

model ProductTag {
  productId String @map("product_id")
  tagId     String @map("tag_id")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tag")
}

//////////////////////
// CATEGORY (TREE)
//////////////////////
model Category {
  id       String  @id @default(uuid())
  name     String
  handle   String  @unique
  parentId String? @map("parent_id")

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryTree")

  products ProductCategory[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("category")
}

model ProductCategory {
  productId  String @map("product_id")
  categoryId String @map("category_id")

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@map("product_category")
}

//////////////////////
// ORDER
//////////////////////
model Order {
  id         String      @id @default(uuid())
  customerId String?     @map("customer_id")
  status     OrderStatus
  total      Decimal     @db.Decimal(12, 2)

  shippingAddress String

  items    OrderItem[]
  payment  Payment?
  shipping Shipping?

  customer Customer? @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("order")
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPING
  COMPLETED
  CANCELLED
}

//////////////////////
// ORDER ITEM (SNAPSHOT)
//////////////////////
model OrderItem {
  id      String @id @default(uuid())
  orderId String @map("order_id")

  sku      String
  price    Decimal @db.Decimal(12, 2)
  quantity Int
  total    Decimal @db.Decimal(12, 2)

  attributes Json // snapshot option tại thời điểm mua

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_item")
}

//////////////////////
// PAYMENT
//////////////////////
model Payment {
  id       String          @id @default(uuid())
  orderId  String          @unique @map("order_id")
  provider PaymentProvider
  status   PaymentStatus
  amount   Decimal         @db.Decimal(12, 2)

  paidAt DateTime? @map("paid_at")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment")
}

enum PaymentProvider {
  COD
  VNPAY
  MOMO
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

//////////////////////
// SHIPPING
//////////////////////
model Shipping {
  id      String         @id @default(uuid())
  orderId String         @unique @map("order_id")
  method  ShippingMethod
  fee     Decimal        @db.Decimal(12, 2)
  status  ShippingStatus

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipping")
}

enum ShippingStatus {
  WAITING
  SHIPPING
  DELIVERED
}

enum ShippingMethod {
  GHTK
  GHN
  SPX
}
