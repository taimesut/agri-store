// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "./generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "mysql"
}

//////////////////////
// USER
//////////////////////
model User {
  id        String @id @default(uuid())
  email     String @unique
  password  String
  firstName String
  lastName  String
}

//////////////////////
// CUSTOMER
//////////////////////
model Customer {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String  @map("password_hash")
  fullName     String  @map("full_name")
  phone        String?

  orders Order[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("customer")
}

//////////////////////
// PRODUCT
//////////////////////
model Product {
  id          String        @id @default(uuid())
  title       String
  handle      String        @unique
  description String?
  status      ProductStatus @default(DRAFT)

  variants   ProductVariant[]
  images     ProductImage[]
  options    ProductOption[]
  tags       ProductTagLink[]
  categories ProductCategory[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("product")
}

enum ProductStatus {
  DRAFT
  PUBLISHED
}

//////////////////////
// PRODUCT IMAGE
//////////////////////
model ProductImage {
  id        String @id @default(uuid())
  productId String @map("product_id") // FK -> product.id
  url       String
  position  Int

  product Product @relation(fields: [productId], references: [id])

  @@map("product_image")
}

//////////////////////
// TAG
//////////////////////
model ProductTag {
  id    String @id @default(uuid())
  value String @unique

  products ProductTagLink[]

  @@map("product_tag")
}

model ProductTagLink {
  productId String @map("product_id") // FK -> product.id
  tagId     String @map("tag_id") // FK -> product_tag.id

  product Product    @relation(fields: [productId], references: [id])
  tag     ProductTag @relation(fields: [tagId], references: [id])

  @@id([productId, tagId])
  @@map("product_tag_link")
}

//////////////////////
// CATEGORY (TREE)
//////////////////////
model Category {
  id       String  @id @default(uuid())
  name     String
  handle   String  @unique
  parentId String? @map("parent_id") // FK -> category.id (self)

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryTree")

  products ProductCategory[]

  createdAt DateTime @default(now()) @map("created_at")

  @@map("category")
}

model ProductCategory {
  productId  String @map("product_id") // FK -> product.id
  categoryId String @map("category_id") // FK -> category.id

  product  Product  @relation(fields: [productId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@id([productId, categoryId])
  @@map("product_category")
}

//////////////////////
// PRODUCT OPTION
//////////////////////
model ProductOption {
  id        String @id @default(uuid())
  productId String @map("product_id") // FK -> product.id
  title     String

  values ProductOptionValue[]

  product Product @relation(fields: [productId], references: [id])

  @@map("product_option")
}

model ProductOptionValue {
  id       String @id @default(uuid())
  optionId String @map("option_id") // FK -> product_option.id
  value    String

  variants VariantOptionValue[]

  option ProductOption @relation(fields: [optionId], references: [id])

  @@map("product_option_value")
}

//////////////////////
// VARIANT
//////////////////////
model ProductVariant {
  id        String  @id @default(uuid())
  productId String  @map("product_id") // FK -> product.id
  sku       String  @unique
  title     String
  price     Decimal @db.Decimal(12, 2)

  product   Product              @relation(fields: [productId], references: [id])
  options   VariantOptionValue[]
  inventory Inventory?

  createdAt DateTime @default(now()) @map("created_at")

  @@map("product_variant")
}

model VariantOptionValue {
  variantId     String @map("variant_id") // FK -> product_variant.id
  optionValueId String @map("option_value_id") // FK -> product_option_value.id

  variant     ProductVariant     @relation(fields: [variantId], references: [id])
  optionValue ProductOptionValue @relation(fields: [optionValueId], references: [id])

  @@id([variantId, optionValueId])
  @@map("variant_option_value")
}

//////////////////////
// INVENTORY
//////////////////////
model Inventory {
  id        String @id @default(uuid())
  variantId String @unique @map("variant_id") // FK -> product_variant.id
  quantity  Int

  variant ProductVariant @relation(fields: [variantId], references: [id])

  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("inventory")
}

//////////////////////
// ORDER
//////////////////////
model Order {
  id         String      @id @default(uuid())
  customerId String?     @map("customer_id") // FK -> customer.id
  status     OrderStatus
  total      Decimal     @db.Decimal(12, 2)

  shippingAddress Json

  items    OrderItem[]
  payment  Payment?
  shipping Shipping?

  customer Customer? @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("order")
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPING
  COMPLETED
  CANCELLED
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id") // FK -> order.id
  variantId String? @map("variant_id")

  productTitle String
  variantTitle String
  unitPrice    Decimal @db.Decimal(12, 2)
  quantity     Int
  total        Decimal @db.Decimal(12, 2)

  order Order @relation(fields: [orderId], references: [id])

  @@map("order_item")
}

//////////////////////
// PAYMENT
//////////////////////
model Payment {
  id       String          @id @default(uuid())
  orderId  String          @unique @map("order_id") // FK -> order.id
  provider PaymentProvider
  status   PaymentStatus
  amount   Decimal         @db.Decimal(12, 2)

  paidAt DateTime? @map("paid_at")

  order Order @relation(fields: [orderId], references: [id])

  @@map("payment")
}

enum PaymentProvider {
  COD
  VNPAY
  MOMO
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

//////////////////////
// SHIPPING
//////////////////////
model Shipping {
  id      String         @id @default(uuid())
  orderId String         @unique @map("order_id") // FK -> order.id
  method  String
  fee     Decimal        @db.Decimal(12, 2)
  status  ShippingStatus

  order Order @relation(fields: [orderId], references: [id])

  @@map("shipping")
}

enum ShippingStatus {
  WAITING
  SHIPPING
  DELIVERED
}
