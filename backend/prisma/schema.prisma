generator client {
  provider     = "prisma-client"
  output       = "./generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "mysql"
}

//////////////////////
// USER
//////////////////////
model User {
  id        String @id @default(uuid())
  email     String @unique
  password  String
  firstName String
  lastName  String
}

//////////////////////////////////////////////////////
// CUSTOMER
//////////////////////////////////////////////////////
model Customer {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  fullName     String
  phone        String?

  orders Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customer")
}

//////////////////////////////////////////////////////
// PRODUCT
//////////////////////////////////////////////////////
model Product {
  id          String        @id @default(uuid())
  title       String
  handle      String        @unique
  description String?
  status      ProductStatus @default(DRAFT)

  options    ProductOption[]
  variants   ProductVariant[]
  images     ProductImage[]
  tags       ProductTagLink[]
  categories ProductCategory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product")
}

enum ProductStatus {
  DRAFT
  PUBLISHED
}

//////////////////////////////////////////////////////
// PRODUCT IMAGE
//////////////////////////////////////////////////////
model ProductImage {
  id        String @id @default(uuid())
  productId String
  url       String
  position  Int

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_image")
}

//////////////////////////////////////////////////////
// CATEGORY
//////////////////////////////////////////////////////
model Category {
  id       String  @id @default(uuid())
  name     String
  handle   String  @unique
  parentId String?

  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryTree")

  products ProductCategory[]

  createdAt DateTime @default(now())

  @@map("category")
}

model ProductCategory {
  productId  String
  categoryId String

  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([productId, categoryId])
  @@map("product_category")
}

//////////////////////////////////////////////////////
// TAG
//////////////////////////////////////////////////////
model ProductTag {
  id    String @id @default(uuid())
  value String @unique

  products ProductTagLink[]

  @@map("product_tag")
}

model ProductTagLink {
  productId String
  tagId     String

  product Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     ProductTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([productId, tagId])
  @@map("product_tag_link")
}

//////////////////////////////////////////////////////
// PRODUCT OPTION
//////////////////////////////////////////////////////
model ProductOption {
  id        String @id @default(uuid())
  productId String
  name      String
  position  Int

  values ProductOptionValue[]

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, name])
  @@map("product_option")
}

model ProductOptionValue {
  id       String @id @default(uuid())
  optionId String
  value    String
  position Int

  option ProductOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  variantsAsOption1 ProductVariant[] @relation("OptionValue1")
  variantsAsOption2 ProductVariant[] @relation("OptionValue2")
  variantsAsOption3 ProductVariant[] @relation("OptionValue3")

  @@unique([optionId, value])
  @@map("product_option_value")
}

//////////////////////////////////////////////////////
// PRODUCT VARIANT
//////////////////////////////////////////////////////
model ProductVariant {
  id        String  @id @default(uuid())
  productId String
  sku       String  @unique
  title     String
  price     Decimal @db.Decimal(12, 2)

  optionValue1Id String?
  optionValue2Id String?
  optionValue3Id String?

  optionValue1 ProductOptionValue? @relation("OptionValue1", fields: [optionValue1Id], references: [id])
  optionValue2 ProductOptionValue? @relation("OptionValue2", fields: [optionValue2Id], references: [id])
  optionValue3 ProductOptionValue? @relation("OptionValue3", fields: [optionValue3Id], references: [id])

  inventory Inventory?

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("product_variant")
}

//////////////////////////////////////////////////////
// INVENTORY
//////////////////////////////////////////////////////
model Inventory {
  id        String @id @default(uuid())
  variantId String @unique
  quantity  Int

  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt

  @@map("inventory")
}

//////////////////////////////////////////////////////
// ORDER
//////////////////////////////////////////////////////
model Order {
  id              String      @id @default(uuid())
  customerId      String?
  status          OrderStatus
  total           Decimal     @db.Decimal(12, 2)
  shippingAddress String

  items    OrderItem[]
  payment  Payment?
  shipping Shipping?

  customer Customer? @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now())

  @@map("order")
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPING
  COMPLETED
  CANCELLED
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String
  sku     String

  productTitle String
  variantTitle String
  unitPrice    Decimal @db.Decimal(12, 2)
  quantity     Int
  total        Decimal @db.Decimal(12, 2)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_item")
}

//////////////////////////////////////////////////////
// PAYMENT
//////////////////////////////////////////////////////
model Payment {
  id       String          @id @default(uuid())
  orderId  String          @unique
  provider PaymentProvider
  status   PaymentStatus
  amount   Decimal         @db.Decimal(12, 2)
  paidAt   DateTime?

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment")
}

enum PaymentProvider {
  COD
  VNPAY
  MOMO
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

//////////////////////////////////////////////////////
// SHIPPING
//////////////////////////////////////////////////////
model Shipping {
  id      String         @id @default(uuid())
  orderId String         @unique
  method  ShippingMethod
  fee     Decimal        @db.Decimal(12, 2)
  status  ShippingStatus

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("shipping")
}

enum ShippingStatus {
  WAITING
  SHIPPING
  DELIVERED
}

enum ShippingMethod {
  GHTK
  GHN
  SPX
}
